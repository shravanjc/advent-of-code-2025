//    val input = """.......S.......
//...............
//.......^.......
//...............
//......^.^......
//...............
//.....^.^.^.....
//...............
//....^.^...^....
//...............
//...^.^...^.^...
//...............
//..^...^.....^..
//...............
//.^.^.^.^.^...^.
//..............."""

val input =
    """......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.^...^...................................................................
.............................................................................................................................................
..................................................................^.^...^.^..................................................................
.............................................................................................................................................
.................................................................^.^.^.^...^.................................................................
.............................................................................................................................................
................................................................^...^...^...^................................................................
.............................................................................................................................................
...............................................................^.^.^.^.^.....^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^...^.^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^.^.^.^...^.............................................................
.............................................................................................................................................
............................................................^...^.^.^.^...^.....^............................................................
.............................................................................................................................................
...........................................................^...^.^.^.^.^.^.....^.^...........................................................
.............................................................................................................................................
..........................................................^.^.^.^.^.^.^.^.^.....^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^.^.....^.^...^.^.^...^.........................................................
.............................................................................................................................................
........................................................^.^.....^.^.^.^.^...^...^...^........................................................
.............................................................................................................................................
.......................................................^...^.^.^.^.....^...^.^.^.^...^.......................................................
.............................................................................................................................................
......................................................^.^...^.^...^...^.^.^.^...^.^...^......................................................
.............................................................................................................................................
.....................................................^...^.^.^...^.^.^.^.^.^.^.^.....^.^.....................................................
.............................................................................................................................................
....................................................^.^.^.^.^...^.^...^.^.^.^.^.^...^.^.^....................................................
.............................................................................................................................................
...................................................^.....^.......^...^...^.^.^...^.^.^...^...................................................
.............................................................................................................................................
..................................................^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^...^..................................................
.............................................................................................................................................
.................................................^...^.^.^.^.^.^...^.^.....^.......^...^.^.^.................................................
.............................................................................................................................................
................................................^.^.^.^...^.^.^.^.^.....^...^...^.^.^...^.^.^................................................
.............................................................................................................................................
...............................................^.^...^.........^.^...^...^...^.^.^.^.....^...^...............................................
.............................................................................................................................................
..............................................^...^.^.^.^...^...^...^.^.^.^.^...^...^.......^.^..............................................
.............................................................................................................................................
.............................................^.^.^.....^.^.^.^.^.^...^.^.^.^...^.....^...^.^...^.............................................
.............................................................................................................................................
............................................^...^.^.^.^.^.^...^.....^.^...^.......^.......^.^.^.^............................................
.............................................................................................................................................
...........................................^.^...^.^.....^.....^.^.^.^...^.^.^.^.^.^.^...^...^.^.^...........................................
.............................................................................................................................................
..........................................^.......^.....^.^.....^.^.....^.^.^...^...^...^.^.....^.^..........................................
.............................................................................................................................................
.........................................^.^.^...^.^...^.^...^.^.^...^.^...^.^.^...^.^.^.^.^.^.^.^.^.........................................
.............................................................................................................................................
........................................^.^...^.....^.^.^.^.^.....^.^.^.^.^.^.........^...^.^.^.^.^.^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.......................................
.............................................................................................................................................
......................................^...^.^.^.^.^...^...^...^.^.^...^.^.^.^...^.^.....^.^.^.......^.^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^...^.^.^.^.^.^.^.......^.^.^.^.^.^...^.....^.^.^...^.^.....................................
.............................................................................................................................................
....................................^.^.......^.^.^...^...^...^...^.^...^.^...^...^.^.^.^.^...^.^.^.....^....................................
.............................................................................................................................................
...................................^...^.^.^.^.^.......^.......^.^...^.^.^.^...^...^...^...^.^.^...^...^.^...................................
.............................................................................................................................................
..................................^...^.^...^.^...^...^.....^.......^.......^.^.^...^...^...^...^.^...^.^.^..................................
.............................................................................................................................................
.................................^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.......^.^.^.^.^.^...^.^...^.^...^.^...^.^.................................
.............................................................................................................................................
................................^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.......^.....^.^.......^.^...^.........^................................
.............................................................................................................................................
...............................^.^...^...^.^.^...^.^...^.^.^.^...^.^.^.^.^.......^.^.^.......^.^.^.^.^.^...^.^...............................
.............................................................................................................................................
..............................^.^.^.^.^.^.^.^.^...^.^.^...^.......^.^.......^...^.^.^...^.^.^...^.^...^.^.^...^..............................
.............................................................................................................................................
.............................^.^.^.....^.^.^...^.^.....^.......^.^.^.^.^.^.^.^.^...^...^.....^.^.^...^.......^.^.............................
.............................................................................................................................................
............................^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.....^.........^.^...^.^.^...^.....^.^.^.^............................
.............................................................................................................................................
...........................^...^.......^.^.^...........^.^.^.^.^.^.^.^.^.^.^...^.^.^...^.....^...^.^.^.^.....^...^...........................
.............................................................................................................................................
..........................^.....^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.......^.^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^...^..........................
.............................................................................................................................................
.........................^...^.......^.^.^...^.^.^.....^...........^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.........................
.............................................................................................................................................
........................^.^...^.^.^...^.^.^.^.....^.^...^.^.^...^.^.....^...............^.^.^.^...^.^.^.^.........^.^........................
.............................................................................................................................................
.......................^.^.....^.^.^.^.^.^.^.....^.^.^.^.^.^.....^.^.^...^.^.^...^.^.^.....^.....^.^...^.^.^.^.....^.^.......................
.............................................................................................................................................
......................^.^.^.^.^.......^.^.^.^.....^.^...^.^.^.^...^...^.......^...^.^.^...^.^.^...^.....^...^.^...^.^.^......................
.............................................................................................................................................
.....................^.....^.^.^.^.....^.^.^.^.....^.^...^.^.....^.^...^.^.^.^.....^...^.^.^.^...^.....^.^...^...^.^.^.^.....................
.............................................................................................................................................
....................^.^.^...^.^.^.^.^.^.^...^.....^.^.^...^.....^...^.....^.^.^...^.^.^.^.....^.^.^.^.^.^...^.^.^...^.^.^....................
.............................................................................................................................................
...................^.^.....^.^...^.......^.^.^.^.^.^.^.^.....^.....^.^.^.^.^...^...^.^.^.^.^...^...^...^.^.^.....^...^.^.^...................
.............................................................................................................................................
..................^.....^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^...^...^.^.^.^.^.^...^.^...^..................
.............................................................................................................................................
.................^.^...^.^.^.^.^...^.^.^...^.^.^.^.....^.^.^.^...^.^.^.^.^.....^...^.^.^.^...^.^.^...^...^...^.^.^.^.^.^.^.^.................
.............................................................................................................................................
................^.^.....^...^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.......^.^.^.^.....^...........^...^.^.^.^...^...^.^.^.^.^.^................
.............................................................................................................................................
...............^.^.^.....^...^...^...^...^.^.^.....^.....^.^.^.^.^.^.^.....^.^.^.^.^.^...^...^.^.....^...^.^.^...^.^.^...^.^.^...............
.............................................................................................................................................
..............^.^.^...^.....^.^.^.^.^...^.......^.^.....^.^.^...^...^...^.^.....^.^.^.^...^.^.^.^...^.^.^...^.....^...^.^.^...^..............
.............................................................................................................................................
.............^.......^...^...^...^...^.^...^...^.^.^.^.^...^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.............
.............................................................................................................................................
............^.^...^.^.^.^...^...^.^...^.^.^...^.^.^...^.^.^...^...^...^...^.^.^.....^.^.^...^.....^.^.^.^.....^.^.^.....^.....^.^............
.............................................................................................................................................
...........^...^.^.^.^...^.^.^.....^.^...^...^.......^.^.^.^.^.^.^.^...^.^.^.^.....^...^.^...^...^...^.^.^.^.^.....^.^...^...^.^.^...........
.............................................................................................................................................
..........^.^.^.....^.^.^.^.^.^...^.^.^.^.^.^.^.^...^...^...^...^.^.^.^.^.....^.........^.^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^..........
.............................................................................................................................................
.........^.^.....^.^.^...^.^.....^.^.^...^...^.^.....^.^.......^.^.^...^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^...^.......^.^.........
.............................................................................................................................................
........^...^.^.^.^.^.....^...^.^.^...^.^.^.^...^.^.^.^...^.^.....^.^...^.^.^.^.^.^.^.^.......^.^.^.....^.^...^.....^...^.^.........^........
.............................................................................................................................................
.......^.^.^.^.^.^.^...^.^.....^.^.^.......^.^.^.^.^.^.^...^.......^.^...^...^...^.^.^.^...^...^...^.^.^.^...^.^.^.^.....^.^.^.^.....^.......
.............................................................................................................................................
......^.^.........^...^.^.^.....^.^.^.^.^.....^.^.^...^.^.....^.^.....^.^.^.^.^.^.^...^...^.^...^.^...^.^.^.^.^.^.^...^.^.^.....^.^.^.^......
.............................................................................................................................................
.....^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.....^...^.^.^.^...^...^.^...^.^.^.^.^...^.^...^.^.^.^.^.^.^.....^.^.....
.............................................................................................................................................
....^...^...^.^.^.....^...^.....^.^.^.....^...^.^.^.^.^.....^.^.....^.^.....^.^.^...^.^.^...^.^.^.^.^.^...^.^.^.^...^.^...^.........^.^.^....
.............................................................................................................................................
...^...^.^.......^...^.^.^.^...^...^.^...^.^.^.^.^...^.^.^.^.........^.^...^.^.^.^.^.^.^.^...^.^.....^...^.^.^...^.^.^.^.......^.^.^.^...^...
.............................................................................................................................................
..^.^.......^.........^.^.^.^.^.^...^.^.^.^.^.^...^.......^.^...^...^...^.^.^.^.^...^.^.^.^...^.^...^.....^...^.....^...^.^.^.^.^.^.^.^.^.^..
.............................................................................................................................................
.^.^...^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.......^.^.......^.^.^.^.^.^...^.^...^.^...^.^...^.^.^.^.^.^.....^...^...^.^.^.^.^...^.^.^.^.^.
............................................................................................................................................."""

var answer = 0L
var allBeamIndexes = mutableMapOf<Int, Set<Int>>()
input.split(System.lineSeparator()).forEachIndexed { index, string ->
    val entryIndex = string.indexOf("S")
    if (entryIndex != -1) {
        println(string)
        allBeamIndexes[index] = setOf(entryIndex)
        return@forEachIndexed
    }
    val previousBeamIndexes = allBeamIndexes[index - 1] ?: return@forEachIndexed

    if (string.contains('^')) {
        previousBeamIndexes.forEach { beamIndex ->
            if (string[beamIndex] == '^') {
                answer++
                allBeamIndexes[index] = allBeamIndexes.getOrDefault(index, emptySet()) + setOf(
                    beamIndex - 1,
                    beamIndex + 1
                )
            } else {
                allBeamIndexes[index] =
                    allBeamIndexes.getOrDefault(index, emptySet()) + setOf(beamIndex)
            }
        }
    } else {
        allBeamIndexes[index] = previousBeamIndexes
    }
    val stringBuilder = StringBuilder(string)
    allBeamIndexes[index]?.forEach {
        stringBuilder.setCharAt(it, '|')
    }
    println(stringBuilder)
}
println("answer: $answer")